// ./swagger/swagger-model-generator.js
import {       
        User,
        License,
        Module,
        Banner,
        categories,
        Product,
        Image,
        UnitValue,
        ProductVariant,
        CustomerDetail,
        CustomerAddressDetail,
        ProductPayment,
        ContactUs,
        Review,
        Testimonial,
        Video,
        Order,
        OrderRecord,
        Payment,
        WebhookLog,
        ErrorLog, } from "../db/dbconnection.js";

/**
 * Map a Sequelize dataType key to OpenAPI type
 */
function mapSequelizeType(key) {
  const k = (key || "").toLowerCase();
  if (k.includes("int") || k.includes("bigint")) return "integer";
  if (k.includes("bool")) return "boolean";
  if (k.includes("float") || k.includes("double") || k.includes("decimal") || k.includes("real")) return "number";
  if (k.includes("date") || k.includes("time")) return "string";
  return "string";
}

/**
 * Build schema for one model
 */
function buildSchemaFromModel(model) {
  if (!model || !model.rawAttributes) return null;

  const props = {};
  const required = [];

  for (const [attr, meta] of Object.entries(model.rawAttributes)) {
    const typeKey = meta.type && meta.type.constructor && meta.type.constructor.key;
    const type = mapSequelizeType(typeKey);
    props[attr] = { type };
    if (meta.allowNull === false && !meta._autoGenerated) required.push(attr);
  }

  return { type: "object", properties: props, ...(required.length ? { required } : {}) };
}

export const generateSequelizeSchemas = async () => {
  const output = {};

  // Models exported by your dbconnection.js
  const modelMap = {
        User,
        License,
        Module,
        Banner,
        categories,
        Product,
        Image,
        UnitValue,
        ProductVariant,
        CustomerDetail,
        CustomerAddressDetail,
        ProductPayment,
        ContactUs,
        Review,
        Testimonial,
        Video,
        Order,
        OrderRecord,
        Payment,
        WebhookLog,
        ErrorLog,
  };

  for (const [name, model] of Object.entries(modelMap)) {
    if (!model) continue;
    const schema = buildSchemaFromModel(model);
    if (schema) output[name] = schema;
  }

  return output;
};
